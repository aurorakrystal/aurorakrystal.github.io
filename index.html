import React, { useState, useEffect, useRef } from 'react';
import { 
  Sparkles, RefreshCw, Moon, Star, BookOpen, ChevronRight, MessageCircle, 
  ArrowDown, ArrowUp, Crown, Sun, Coins, Heart, Shield, Gem, Mic, 
  Scale, Umbrella, Sword, Hammer, Brain, Flame, Cloud, Wind, Zap, Ghost,
  Anchor, Feather, Gift, Briefcase, Lock, Clock, Hash, User, Mail, Send, Loader2, XCircle, FileText
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc } from 'firebase/firestore';

// --- Firebase åˆå§‹åŒ– ---
// è«‹è¨˜å¾—åœ¨ CodeSandbox æˆ–æ‚¨çš„å°ˆæ¡ˆä¸­æ›¿æ›æˆæ‚¨çš„çœŸå¯¦ Firebase Config
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); 
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'ziling-divination';

// --- è³‡æ–™åº«å®šç¾© ---

const starIcons = {
  ziwei: <Crown size={56} strokeWidth={1.5} />,
  tianji: <Brain size={56} strokeWidth={1.5} />,
  taiyang: <Sun size={56} strokeWidth={1.5} />,
  wuqu: <Coins size={56} strokeWidth={1.5} />,
  tiantong: <Heart size={56} strokeWidth={1.5} />,
  lianzhen: <Flame size={56} strokeWidth={1.5} />,
  tianfu: <Shield size={56} strokeWidth={1.5} />,
  taiyin: <Moon size={56} strokeWidth={1.5} />,
  tanlang: <Gem size={56} strokeWidth={1.5} />,
  jumen: <MessageCircle size={56} strokeWidth={1.5} />,
  tianxiang: <Scale size={56} strokeWidth={1.5} />,
  tianliang: <Umbrella size={56} strokeWidth={1.5} />,
  qisha: <Sword size={56} strokeWidth={1.5} />,
  pojun: <Hammer size={56} strokeWidth={1.5} />,
  default: <Star size={56} strokeWidth={1.5} />
};

// ä¸»æ˜Ÿ 14 å¼µ (ä¾æ“šã€Šæ˜Ÿæ›œäº®æš—çš„ä¸åŒå–è±¡ã€‹æ›´æ–°)
const mainStarsData = [
  { 
    id: 'ziwei', name: 'ç´«å¾®', 
    upright: { 
        keyword: 'é ˜å°çµ±å¾¡ã€å°Šè²´', 
        desc: 'ã€äº®ã€‘å¦‚çš‡å¸èˆ¬å°Šè²´ï¼Œå…·å‚™å¼·å¤§çš„çµ±ç±Œèƒ½åŠ›èˆ‡ç†æ€§ã€‚èƒ½ç´ç™¾å·ï¼Œåœ°ä½å´‡é«˜ï¼Œå±•ç¾å‡ºå¤§æ°£èˆ‡ç©©é‡çš„é ˜è¢–é¢¨ç¯„ã€‚',
        advice: 'å±•ç¾ä½ çš„éœ¸æ°£èˆ‡ç†æ€§ï¼Œç¾åœ¨æ˜¯çµ±ç±Œå¤§å±€ã€ç™¼è™Ÿæ–½ä»¤çš„æœ€ä½³æ™‚åˆ»ï¼Œçœ¾äººçš†æœƒæœå¾ã€‚'
    }, 
    reversed: { 
        keyword: 'å­¤å‚²ä»»æ€§ã€ç–‘å¿ƒ', 
        desc: 'ã€æš—ã€‘å¦‚åŒæ˜å›ï¼Œå–œæƒ¡éš¨å¿ƒï¼Œéåº¦åœ¨æ„é¢å­èˆ‡æ’å ´ã€‚ç–‘å¿ƒç—…é‡ï¼Œè½ä¸é€²è««è¨€ï¼Œå®¹æ˜“å› éŒ¯èª¤çš„æ¬ŠåŠ›ä½¿ç”¨è€Œé™·å…¥å­¤ç¨ã€‚',
        advice: 'æ”¾ä¸‹ç„¡è¬‚çš„é¢å­èˆ‡ç–‘å¿ƒï¼Œä¸è¦ä¸€æ„å­¤è¡Œã€‚ä½ çš„ä»»æ€§å¯èƒ½æœƒå°è‡´æ¬ŠåŠ›å¤±è¡¡æˆ–äººéš›å­¤ç«‹ã€‚'
    },
    element: 'åœŸ'
  },
  { 
    id: 'tianfu', name: 'å¤©åºœ', 
    upright: { 
        keyword: 'ç©©å¥ç®¡ç†ã€æ ¼å±€', 
        desc: 'ã€äº®ã€‘å¦‚ç‹çˆºèˆ¬æŒç®¡è²¡åº«ï¼Œå…·å‚™å„ªç§€çš„ç®¡ç†èƒ½åŠ›èˆ‡è™Ÿå¬åŠ›ã€‚è¡Œäº‹ç©©å¥ç€Ÿç‘ï¼Œèƒ½å±ˆèƒ½ä¼¸ï¼Œæ“æœ‰å»£å¤§çš„ç™¼å±•å¹³å°ã€‚',
        advice: 'æ¡å–ç©©ç´®ç©©æ‰“çš„ç­–ç•¥ï¼Œåˆ©ç”¨ç¾æœ‰çš„è³‡æºèˆ‡å¹³å°é€²è¡Œç®¡ç†ï¼Œä¿å®ˆè¬¹æ…æœƒå¸¶ä¾†é•·é åˆ©ç›Šã€‚'
    }, 
    reversed: { 
        keyword: 'ä¿å®ˆæ€¯å¼±ã€è¨ˆè¼ƒ', 
        desc: 'ã€æš—ã€‘éåº¦ä¿å®ˆå°è‡´ç¼ºä¹å‰µæ–°ï¼Œå¿ƒé«˜æ°£å‚²å»åˆè†½å°æ€•äº‹ã€‚å®¹æ˜“åœ¨é‡‘éŒ¢ä¸Šéæ–¼è¨ˆè¼ƒï¼ˆæ‘³é–€ï¼‰ï¼Œæˆ–åœ¨é—œéµæ™‚åˆ»ç¼ºä¹è²¬ä»»æ„Ÿã€‚',
        advice: 'ä¸è¦å¤ªéæ–¤æ–¤è¨ˆè¼ƒæˆ–é€ƒé¿è²¬ä»»ï¼Œè©¦è‘—æ‰“ç ´ä¿å®ˆçš„å¿ƒæ…‹ï¼Œéåº¦è¬¹æ…åªæœƒè®“ä½ éŒ¯å¤±è‰¯æ©Ÿã€‚'
    },
    element: 'åœŸ'
  },
  { 
    id: 'taiyang', name: 'å¤ªé™½', 
    upright: { 
        keyword: 'ç†±æƒ…åšæ„›ã€å¦ç‡', 
        desc: 'ã€äº®ã€‘å¦‚æ—­æ—¥æ±æ˜‡ï¼Œå……æ»¿é™½å‰›ä¹‹æ°£èˆ‡æ­£èƒ½é‡ã€‚æ¨‚æ–¼å¥‰ç»ï¼Œå…¬é–‹é€æ˜ï¼Œå®¹æ˜“æˆç‚ºçœ¾äººçŸšç›®çš„ç„¦é»ï¼Œåè²é¡¯èµ«ã€‚',
        advice: 'åƒå¤ªé™½ä¸€æ¨£ç‡ƒç‡’è‡ªå·±ç…§äº®ä»–äººï¼Œå…¬é–‹å¦ç‡åœ°è¡¨é”ä½ çš„æƒ³æ³•ï¼Œä½ çš„ç†±æƒ…æ˜¯è§£æ±ºå•é¡Œçš„é‘°åŒ™ã€‚'
    }, 
    reversed: { 
        keyword: 'è¯è€Œä¸å¯¦ã€å‹ç¢Œ', 
        desc: 'ã€æš—ã€‘é›–ç„¶æ¶çœ¼ä½†æµæ–¼è¡¨é¢ï¼ˆè¯è€Œä¸å¯¦ï¼‰ï¼Œå®¹æ˜“å› éåº¦ç†±å¿ƒè€Œæ‹›æƒ¹æ˜¯éæˆ–å¤šç®¡é–’äº‹ã€‚ä¸åˆ©ç”·æ€§ï¼Œä¸”æœ‰å‹è€Œç„¡ç²çš„è·¡è±¡ã€‚',
        advice: 'æ”¶æ–‚éåº¦çš„ç†±æƒ…ï¼Œé¿å…ä»‹å…¥ä»–äººçš„å› æœã€‚ä¸è¦ç‚ºäº†è™›åè€Œè®“è‡ªå·±é™·å…¥ç„¡è¬‚çš„å‹ç¢Œèˆ‡æ˜¯éä¸­ã€‚'
    },
    element: 'ç«'
  },
  { 
    id: 'taiyin', name: 'å¤ªé™°', 
    upright: { 
        keyword: 'ç´°è†©æº«æŸ”ã€è¨ˆåŠƒ', 
        desc: 'ã€äº®ã€‘å¦‚æœˆäº®èˆ¬æº«æŸ”ï¼Œå¿ƒæ€ç´°è†©ä¸”æ³¨é‡ç´°ç¯€ã€‚æ“…é•·è¦åŠƒèˆ‡ç´¯ç©ï¼ˆè²¡å¯Œæˆ–æƒ…æ„Ÿï¼‰ï¼Œæ„›ä¹¾æ·¨æ•´æ½”ï¼Œå±•ç¾å‡ºå…§æ–‚çš„ç¾æ„Ÿã€‚',
        advice: 'ç™¼æ®ä½ çš„ç´°è†©èˆ‡è¨ˆåŠƒèƒ½åŠ›ï¼Œæ…¢æ…¢ç´¯ç©è³‡æºã€‚ä»¥æŸ”å…‹å‰›ï¼Œæº«æŸ”çš„å …æŒæœƒå¸¶ä¾†è±åšçš„å›å ±ã€‚'
    }, 
    reversed: { 
        keyword: 'æƒ…ç·’æ°¾æ¿«ã€æ½”ç™–', 
        desc: 'ã€æš—ã€‘å…§å¿ƒè‡ªå‘ä¸”ç¼ºä¹å®‰å…¨æ„Ÿï¼Œå®¹æ˜“å¤šæ„å–„æ„Ÿæˆ–éåº¦æ½”ç™–ï¼ˆé¾œæ¯›ï¼‰ã€‚æ„å¿—åŠ›è–„å¼±ï¼Œè™•ç†äº‹æƒ…å¤ªéç·©æ…¢ä¸”ç„¡ä¸»è¦‹ã€‚',
        advice: 'ä¸è¦è¢«æƒ…ç·’å‹’ç´¢ï¼Œä¹Ÿä¸è¦é™·å…¥ç„¡æ­¢ç›¡çš„ç´°ç¯€ç³¾çµã€‚å»ºç«‹è‡ªä¿¡ï¼Œå‹‡æ•¢åšå‡ºæ±ºå®šï¼Œåˆ¥è®“ä¸å®‰æ„Ÿä¸»å°ä½ ã€‚'
    },
    element: 'æ°´'
  },
  { 
    id: 'wuqu', name: 'æ­¦æ›²', 
    upright: { 
        keyword: 'å‰›æ¯…æœæ±ºã€åŸ·è¡Œ', 
        desc: 'ã€äº®ã€‘å¦‚å‰›æ¯…ä¹‹å°‡ï¼ŒåŸ·è¡ŒåŠ›æ¥µå¼·ï¼Œä¸ç•æŒ«æŠ˜èˆ‡åƒè‹¦ã€‚åœ¨é‡‘éŒ¢èˆ‡é‡‘èæ–¹é¢é‹å‹¢æ¥µä½³ï¼Œåšäº‹æœæ–·è² è²¬ï¼Œèƒ½ç¨ç«‹å®Œæˆä»»å‹™ã€‚',
        advice: 'ç¾åœ¨æ˜¯å±•ç¾ã€Œç¡¬å¯¦åŠ›ã€çš„æ™‚å€™ã€‚å¿«åˆ€æ–¬äº‚éº»ï¼Œç›´æ¥åˆ‡å…¥æ ¸å¿ƒåˆ©ç›Šï¼Œä¸è¦æ‹–æ³¥å¸¶æ°´ã€‚'
    }, 
    reversed: { 
        keyword: 'å›ºåŸ·çŸ­æ…®ã€å¯¡æƒ…', 
        desc: 'ã€æš—ã€‘éåº¦å‰›ç¡¬å°è‡´ä¸é€šäººæƒ…ï¼Œå€”å¼·å›ºåŸ·ã€‚å®¹æ˜“è®Šæˆå®ˆè²¡å¥´ï¼Œè¦–é‡çŸ­æ·ºï¼ˆçŸ­æ…®ï¼‰ï¼Œåœ¨äººéš›èˆ‡å®¶åº­é—œä¿‚ä¸Šè¼ƒç‚ºæ·¡è–„å­¤å‰‹ã€‚',
        advice: 'ä¸è¦ç‚ºäº†éŒ¢è²¡æˆ–åŸå‰‡è€Œå‚·äº†æ„Ÿæƒ…ã€‚è©¦è‘—æŸ”è»Ÿä¸€äº›ï¼Œå¤ªéå›ºåŸ·å·±è¦‹åªæœƒè®“ä½ é™·å…¥å­¤ç«‹ç„¡æ´ã€‚'
    },
    element: 'é‡‘'
  },
  { 
    id: 'tianxiang', name: 'å¤©ç›¸', 
    upright: { 
        keyword: 'æºé€šå”èª¿ã€å‘¨å…¨', 
        desc: 'ã€äº®ã€‘å¦‚å®°ç›¸è¼”æ”¿ï¼Œæ–¯æ–‡æœ‰ç¦®ä¸”æ€æ…®å‘¨å…¨ã€‚æ“…é•·æºé€šå”èª¿ï¼Œé‡è¦–äººéš›å’Œè«§èˆ‡å®¶åº­ï¼Œèƒ½æä¾›å¼·å¤§çš„è¼”ä½åŠ©åŠ›ã€‚',
        advice: 'å–„ç”¨ä½ çš„æºé€šæŠ€å·§èˆ‡è¦ªå’ŒåŠ›ï¼Œæ‰®æ¼”å”èª¿è€…çš„è§’è‰²ã€‚æ³¨é‡å¤–åœ¨å½¢è±¡èˆ‡äººå’Œï¼Œæœƒç‚ºä½ å¸¶ä¾†å¥½é‹ã€‚'
    }, 
    reversed: { 
        keyword: 'éš¨æ³¢é€æµã€åƒè™§', 
        desc: 'ã€æš—ã€‘ç‰†é ­è‰éš¨é¢¨å€’ï¼Œç¼ºä¹ä¸»è¦‹èˆ‡æ„å¿—åŠ›ã€‚å®¹æ˜“æ²å…¥æ–‡æ›¸åˆç´„çš„ç³¾ç´›ï¼Œæˆ–å› éåº¦ç†±å¿ƒè€Œã€Œå¥½å¿ƒæ²’å¥½å ±ã€ï¼Œå®¹æ˜“åƒè™§ã€‚',
        advice: 'çœ‹æ¸…æ¥šåˆç´„ç´°ç¯€ï¼Œå …æŒè‡ªå·±çš„åŸå‰‡ï¼Œä¸è¦ç›²ç›®è·Ÿéš¨ä»–äººã€‚å°å¿ƒã€Œçˆ›å¥½äººã€çš„å‚¾å‘è®“ä½ èƒŒé»‘é‹ã€‚'
    },
    element: 'æ°´'
  },
  { 
    id: 'lianzhen', name: 'å»‰è²', 
    upright: { 
        keyword: 'è‡ªå¾‹å»‰æ½”ã€é­…åŠ›', 
        desc: 'ã€äº®ã€‘æ¬¡æ¡ƒèŠ±æ˜Ÿï¼Œå…·å‚™å„ªç§€çš„ç¤¾äº¤æ‰‹è…•èˆ‡è—è¡“æ‰è¯ã€‚åšäº‹äº•äº•æœ‰æ¢ï¼Œå…¬ç§åˆ†æ˜ï¼ˆå»‰æ½”ï¼‰ï¼Œåœ¨äº‹æ¥­ä¸Šèƒ½å±•ç¾é«˜åº¦çš„è‡ªå¾‹èˆ‡é­…åŠ›ã€‚',
        advice: 'ç™¼æ®ä½ çš„ç¤¾äº¤é­…åŠ›èˆ‡å°ˆæ¥­åº¦ï¼Œå»ºç«‹è‰¯å¥½çš„äººè„ˆç¶²ã€‚è‡ªå¾‹èˆ‡æ¢ç†åˆ†æ˜æ˜¯ä½ æˆåŠŸçš„é—œéµã€‚'
    }, 
    reversed: { 
        keyword: 'æ¥µç«¯ååŸ·ã€ç³¾ç´›', 
        desc: 'ã€æš—ã€‘å¿ƒçµé›£è§£ï¼Œå®¹æ˜“é‘½ç‰›è§’å°–æˆ–èµ°æ¥µç«¯ã€‚éœ€æ³¨æ„æ³•å¾‹ç³¾ç´›ã€æ„Ÿæƒ…çˆ›æ¡ƒèŠ±æˆ–æ„å¤–è¡€å…‰ï¼Œæƒ…ç·’èµ·ä¼åŠ‡çƒˆã€‚',
        advice: 'è§£é–‹å…§å¿ƒçš„å¿ƒçµï¼Œä¸è¦å¤ªéååŸ·ã€‚å°å¿ƒè™•ç†æ„Ÿæƒ…èˆ‡äººéš›é‚Šç•Œï¼Œé¿å…å› æƒ…ç·’å¤±æ§è€Œå¼•ç™¼è¡çªã€‚'
    },
    element: 'ç«'
  },
  { 
    id: 'qisha', name: 'ä¸ƒæ®º', 
    upright: { 
        keyword: 'è¡å‹åè¶³ã€é–‹å‰µ', 
        desc: 'ã€äº®ã€‘å¦‚è‚…æ®ºä¹‹å°‡ï¼Œå¹¹å‹åè¶³ã€‚æ•¢æ„›æ•¢æ¨ï¼Œè¿½æ±‚æ¿€æƒ…èˆ‡ä¸»å°æ¬Šã€‚æœ‰å¼·çƒˆç‰©è³ªæ…¾æœ›ï¼Œæ“…é•·é€éå†’éšªã€æŠ•è³‡ç­‰é«˜é¢¨éšªæ–¹å¼ç²åˆ©ã€‚',
        advice: 'æ‹¿å‡ºé­„åŠ›èˆ‡åŸ·è¡ŒåŠ›ï¼ç¾åœ¨æ˜¯é€éå†’éšªèˆ‡çªç ´ä¾†ç²åˆ©çš„æ™‚æ©Ÿï¼Œä½†è¦å°‡é€™è‚¡è¡å‹è½‰åŒ–ç‚ºå»ºè¨­æ€§çš„é–‹å‰µåŠ›é‡ã€‚'
    }, 
    reversed: { 
        keyword: 'è¡å‹•é­¯è½ã€æŒ«æŠ˜', 
        desc: 'ã€æš—ã€‘å¤–è¡¨è¡å‹•å…§å¿ƒçŒ¶è±«ï¼Œå®¹æ˜“æ„æ°£ç”¨äº‹ã€‚æƒ³æŒæ§å±€é¢å»å¸¸å¼•ç™¼è¡çªï¼Œé©åˆå–®æ‰“ç¨é¬¥ä½†æ˜“æ„Ÿå­¤ç¨ã€‚',
        advice: 'å†·éœä¸‹ä¾†ï¼Œè¡å‹•å®¹æ˜“èª¤äº‹ã€‚é«˜é¢¨éšªé›–æœ‰é«˜å›å ±ï¼Œä½†æ­¤åˆ»éœ€é˜²ç¯„æŒ«æŠ˜ï¼Œé¿å…å› æŒæ§æ¬²éå¼·è€Œç‰çŸ³ä¿±ç„šã€‚'
    },
    element: 'é‡‘'
  },
  { 
    id: 'tianji', name: 'å¤©æ©Ÿ', 
    upright: { 
        keyword: 'æ©Ÿæ™ºéˆæ´»ã€ç­–ç•¥', 
        desc: 'ã€äº®ã€‘è»å¸«é‹ç±Œå¸·å¹„ï¼Œåæ‡‰éˆæ•ï¼Œè¨ˆç•«å‘¨è©³ã€‚å–„æ–¼è®Šå‹•ä¸­å°‹æ‰¾æ©Ÿæœƒï¼Œé©åˆå‹•è…¦è¦åŠƒã€‚',
        advice: 'å¤šå‹•è…¦ç­‹ï¼Œè¦åŠƒå‘¨å…¨çš„ç­–ç•¥ã€‚åˆ©ç”¨ä½ çš„éˆæ´»åæ‡‰ä¾†æ‡‰å°è®ŠåŒ–ï¼Œæ™ºå–å‹æ–¼åŠ›æ•µã€‚'
    }, 
    reversed: { 
        keyword: 'ç„¦æ…®ç®—è¨ˆã€è‡ªèª¤', 
        desc: 'ã€æš—ã€‘è°æ˜åè¢«è°æ˜èª¤ï¼Œæ€æ…®éå¤šå°è‡´ç²¾ç¥ç„¦æ…®ã€‚å®¹æ˜“å› éåº¦ç®—è¨ˆæˆ–æŠ•æ©Ÿå¿ƒæ…‹è€Œæ‹›è‡´å¤±æ•—ã€‚',
        advice: 'åœæ­¢ç„¡è¬‚çš„ç„¦æ…®èˆ‡çŒœç–‘ï¼Œè®“å¤§è…¦ä¼‘æ¯ä¸€ä¸‹ã€‚è…³è¸å¯¦åœ°ï¼Œä¸è¦è©¦åœ–èµ°æ·å¾‘æˆ–è€å°è°æ˜ã€‚'
    },
    element: 'æœ¨'
  },
  { 
    id: 'tiantong', name: 'å¤©åŒ', 
    upright: { 
        keyword: 'ç¦æ°£éš¨ç·£ã€äº«å—', 
        desc: 'ã€äº®ã€‘ç¦æ˜Ÿé«˜ç…§ï¼Œä¿æœ‰èµ¤å­ä¹‹å¿ƒã€‚é‡è¦–å¿ƒéˆäº¤æµèˆ‡ç”Ÿæ´»å“è³ªï¼Œé©åˆç©©å®šã€å›ºå®šçš„ç™¼å±•æ¨¡å¼ã€‚',
        advice: 'ä¿æŒæ¨‚è§€ï¼Œå–„ç”¨è¦ªå’ŒåŠ›èˆ‡é©æ‡‰æ€§ã€‚å°æ–¼é‡‘éŒ¢èˆ‡æ„Ÿæƒ…ä¸å¦¨éš¨æ€§ä¸€äº›ï¼Œç¦æ°£è‡ªç„¶æœƒä¾†ã€‚'
    }, 
    reversed: { 
        keyword: 'æ‡¶æ•£ä¾è³´ã€é€ƒé¿', 
        desc: 'ã€æš—ã€‘éæ–¼å®‰é€¸å°è‡´å¤±å»å‹•åŠ›ï¼Œé‡å›°é›£å‚¾å‘é€ƒé¿ã€‚å®¹æ˜“ä¾è³´ä¼´ä¾¶æˆ–å¤–æ´ï¼Œæ€•å—å‚·è€Œé€€ç¸®ã€‚',
        advice: 'ä¸è¦å†é€ƒé¿ç¾å¯¦äº†ï¼Œéåº¦ä¾è³´åªæœƒè®“ä½ åœæ»¯ä¸å‰ã€‚éœ€åœ¨å®‰é€¸ä¸­å°‹æ‰¾å‹•åŠ›ï¼ŒåŸ¹é¤Šç¨ç«‹é¢å°å•é¡Œçš„å‹‡æ°£ã€‚'
    },
    element: 'æ°´'
  },
  { 
    id: 'tanlang', name: 'è²ªç‹¼', 
    upright: { 
        keyword: 'å…«é¢ç²ç“ã€å¤šè—', 
        desc: 'ã€äº®ã€‘æ…¾æœ›ä¹‹ç¥ï¼Œå…«é¢ç²ç“ï¼Œå­¸ç¿’åŠ›èˆ‡é©æ‡‰åŠ›å¼·ã€‚åœ¨ç¤¾äº¤å ´åˆå¦‚é­šå¾—æ°´ï¼Œå……æ»¿æ©Ÿæœƒèˆ‡å¸å¼•åŠ›ã€‚',
        advice: 'ç©æ¥µå±•ç¾ä½ çš„æ‰è¯èˆ‡é­…åŠ›ï¼Œå¤šåƒåŠ ç¤¾äº¤æ´»å‹•ã€‚ä½ çš„æ…¾æœ›æ˜¯ä½ å‰é€²çš„å‹•åŠ›ï¼Œå»çˆ­å–å§ï¼'
    }, 
    reversed: { 
        keyword: 'è²ªæ…¾å¤±æ§ã€è™›æµ®', 
        desc: 'ã€æš—ã€‘æ…¾æœ›å¤±æ§ï¼Œå®¹æ˜“æ²ˆè¿·æ–¼ä¸è‰¯å—œå¥½æˆ–è‚‰æ…¾ã€‚æŠ•æ©Ÿå¿ƒæ…‹é‡ï¼Œå®¹æ˜“æ‹›æƒ¹çˆ›æ¡ƒèŠ±æˆ–å› å°å¤±å¤§ã€‚',
        advice: 'å…‹åˆ¶éåº¦çš„è²ªå¿µèˆ‡æ…¾æœ›ï¼Œè…³è¸å¯¦åœ°ã€‚å°å¿ƒæ¡ƒè‰²ç³¾ç´›èˆ‡æŠ•æ©Ÿé™·é˜±ï¼Œä»¥å…èº«æ•—åè£‚ã€‚'
    },
    element: 'æœ¨/æ°´'
  },
  { 
    id: 'jumen', name: 'å·¨é–€', 
    upright: { 
        keyword: 'èƒ½è¨€å–„é“ã€æ´å¯Ÿ', 
        desc: 'ã€äº®ã€‘è§€å¯ŸåŠ›æ•éŠ³ï¼Œèƒ½æ´å¯Ÿäººå¿ƒèˆ‡é»‘æš—é¢ã€‚å£æ‰æ¥µä½³ï¼Œå–„æ–¼æ·±æ€èˆ‡ç ”ç©¶ï¼Œèƒ½æŒ–æ˜äº‹ç‰©çš„æ ¸å¿ƒã€‚',
        advice: 'å–„ç”¨ä½ çš„å£æ‰èˆ‡åˆ†æèƒ½åŠ›ï¼Œæ·±å…¥æºé€šã€‚ä½ çš„æ´å¯ŸåŠ›èƒ½å¹«ä½ çœ‹ç©¿çœŸç›¸ï¼Œè§£æ±ºè¤‡é›œå•é¡Œã€‚'
    }, 
    reversed: { 
        keyword: 'å£èˆŒæ˜¯éã€å¤šç–‘', 
        desc: 'ã€æš—ã€‘ç¦å¾å£å‡ºï¼Œå®¹æ˜“å¼•ç™¼å£èˆŒæ˜¯éã€‚å…§å¿ƒé™°æš—å¤šç–‘ï¼Œå®¹æ˜“èª¤è§£ä»–äººæˆ–è¢«ä»–äººèª¤è§£ï¼Œäººéš›é—œä¿‚ç·Šå¼µã€‚',
        advice: 'å°‘èªªå¤šåšï¼Œè¬¹è¨€æ…è¡Œã€‚èª¿æ•´è² é¢æ€è€ƒçš„ç¿’æ…£ï¼Œä¸è¦ç¸½æ˜¯å¾€å£è™•æƒ³ï¼Œé¿å…æ²å…¥å…«å¦ã€‚'
    },
    element: 'æ°´'
  },
  { 
    id: 'tianliang', name: 'å¤©æ¢', 
    upright: { 
        keyword: 'æˆç†Ÿè”­åº‡ã€è§£å„', 
        desc: 'ã€äº®ã€‘è€äººæ˜Ÿï¼Œæˆç†Ÿç©©é‡ï¼Œè¬›æ±‚åŸå‰‡ã€‚èƒ½é€¢å‡¶åŒ–å‰ï¼Œå…·æœ‰ç…§é¡§ä»–äººçš„è²¬ä»»æ„Ÿèˆ‡é•·è¼©ç·£ã€‚',
        advice: 'å …æŒä½ çš„åŸå‰‡èˆ‡æ­£ç¾©æ„Ÿï¼Œå°‹æ±‚é•·è¼©çš„å»ºè­°ã€‚æ‰®æ¼”ç…§é¡§è€…çš„è§’è‰²ï¼ŒåŠ©äººå³æ˜¯åŠ©å·±ã€‚'
    }, 
    reversed: { 
        keyword: 'è€æ°£æ©«ç§‹ã€å›ºåŸ·', 
        desc: 'ã€æš—ã€‘éæ–¼èªªæ•™è®“äººå­ç…©ï¼Œå€šè€è³£è€ã€‚å›ºåŸ·å·±è¦‹ï¼Œéåº¦æŒ‘å‰”ç´°ç¯€ï¼Œå®¹æ˜“é™·å…¥äººéš›å­¤ç«‹ã€‚',
        advice: 'æ”¾ä¸‹èº«æ®µï¼Œä¸è¦å¤ªæ„›èªªæ•™ã€‚å¤šå‚¾è½ä»–äººçš„æ„è¦‹ï¼Œå¤ªéå›ºåŸ·åªæœƒè®“ä½ è®Šå¾—å­¤ç¨ã€‚'
    },
    element: 'åœŸ'
  },
  { 
    id: 'pojun', name: 'ç ´è»', 
    upright: { 
        keyword: 'çªç ´å‰µæ–°ã€å…ˆé‹’', 
        desc: 'ã€äº®ã€‘è€—æ˜Ÿï¼Œä¸ç ´ä¸ç«‹ã€‚å…·å‚™å¼·å¤§çš„ç ´å£èˆ‡å»ºè¨­åŠ›ï¼Œé©åˆæ¨ç¿»èˆŠåˆ¶ï¼Œé–‹å‰µå…¨æ–°çš„å±€é¢ã€‚',
        advice: 'å¤§è†½å‰µæ–°ï¼Œæ‰“ç ´èˆŠæœ‰çš„æ¡†æ¶ï¼ç¾åœ¨ä¸æ˜¯å®ˆæˆçš„æ™‚å€™ï¼Œå¾¹åº•çš„æ”¹è®Šæ‰èƒ½å¸¶ä¾†ç”Ÿæ©Ÿã€‚'
    }, 
    reversed: { 
        keyword: 'ç›²ç›®ç ´å£ã€æè€—', 
        desc: 'ã€æš—ã€‘ç ´å£åŠ›å¤±æ§ï¼Œç‚ºäº†æ”¹è®Šè€Œæ”¹è®Šï¼Œå°è‡´è³‡æºè€—ç›¡ã€‚å…­è¦ªç·£è–„ï¼Œè¡Œäº‹é­¯è½ä¸è¨ˆå¾Œæœã€‚',
        advice: 'ä¸è¦ç›²ç›®ç ´å£ï¼Œæ³¨æ„è³‡æºçš„æ¶ˆè€—ã€‚åœ¨æ”¹è®Šä¹‹å‰å…ˆè©•ä¼°ä»£åƒ¹ï¼Œé¿å…é€ æˆä¸å¯æŒ½å›çš„æå¤±ã€‚'
    },
    element: 'æ°´'
  }
];

// è¼”ç‰Œ 18 å¼µ
const auxStarsData = [
  { id: 'wenchang', name: 'æ–‡æ˜Œ', type: 'lucky', keyword: 'æ­£çµ±æ–‡æ›¸ã€ç†æ€§', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨æ­£çµ±å­¸è¡“ã€æ–‡æ›¸å¥‘ç´„ã€SOPã€ç†æ€§æºé€šã€‚', advice: 'å–„ç”¨ç™½ç´™é»‘å­—çš„å¥‘ç´„ä¿éšœæ¬Šç›Šï¼Œæºé€šæ™‚ä¿æŒç†æ€§èˆ‡é‚è¼¯ã€‚' },
  { id: 'wenqu', name: 'æ–‡æ›²', type: 'lucky', keyword: 'æ„Ÿæ€§æ‰è¯ã€å£æ‰', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨æ„Ÿæ€§ã€è—è¡“æ‰è¯ã€å£æ‰è¡¨é”ã€éæ­£çµ±é€”å¾‘ã€æ¡ƒèŠ±ã€‚', advice: 'ç™¼æ®ä½ çš„å‰µæ„ã€ç›´è¦ºèˆ‡å€‹äººé­…åŠ›ï¼Œç”¨æ„Ÿæ€§å»æ‰“å‹•äººå¿ƒã€‚' },
  { id: 'zuofu', name: 'å·¦è¼”', type: 'lucky', keyword: 'ç”·å¹³è¼©ã€æ˜åŠ©åŠ›', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨ã€Œç”·æ€§ã€å¹³è¼©æˆ–æ™šè¼©çš„åŠ©åŠ›ï¼Œå±¬æ–¼ã€Œæ˜é¢ã€ä¸Šçš„å…·é«”å¹«åŠ©ï¼ˆå¦‚å‡ºéŒ¢å‡ºåŠ›ï¼‰ã€‚', advice: 'å°‹æ±‚ç”·æ€§åŒäº‹ã€æœ‹å‹æˆ–åˆä½œå¤¥ä¼´çš„å…·é«”å”åŠ©ï¼Œåœ˜çµåŠ›é‡å¤§ã€‚' },
  { id: 'youbi', name: 'å³å¼¼', type: 'lucky', keyword: 'å¥³å¹³è¼©ã€æš—æ”¯æŒ', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨ã€Œå¥³æ€§ã€å¹³è¼©æˆ–æ™šè¼©çš„åŠ©åŠ›ï¼Œå±¬æ–¼ã€Œéš±æ€§ã€çš„ç²¾ç¥æ”¯æŒæˆ–ç§ä¸‹å”èª¿ã€‚', advice: 'ç•™æ„å¥³æ€§å‹äººçš„å»ºè­°ï¼Œæˆ–å°‹æ±‚ç§ä¸‹çš„æºé€šå”èª¿èˆ‡ç²¾ç¥æ”¯æŒã€‚' },
  { id: 'tiankui', name: 'å¤©é­', type: 'lucky', keyword: 'ç”·é•·è¼©ã€æ˜ææ‹”', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨ã€Œç”·æ€§ã€é•·è¼©æˆ–ä¸Šå¸çš„ææ‹”ï¼Œå±¬æ–¼ã€Œæ˜é¢ã€çš„æ©Ÿæœƒèˆ‡è²´äººã€‚', advice: 'å¤šå‘ç”·æ€§é•·è¼©æˆ–ä¸»ç®¡è«‹ç›Šï¼Œå±•ç¾ä½ çš„èƒ½åŠ›ï¼Œæ©Ÿæœƒå°±åœ¨çœ¼å‰ã€‚' },
  { id: 'tianyue', name: 'å¤©é‰', type: 'lucky', keyword: 'å¥³é•·è¼©ã€æš—é—œç…§', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨ã€Œå¥³æ€§ã€é•·è¼©æˆ–ä¸Šå¸çš„é—œç…§ï¼Œå±¬æ–¼ã€Œæš—ä¸­ã€çš„æ©Ÿæœƒèˆ‡è²´äººã€‚', advice: 'ç•™æ„å¥³æ€§é•·è¼©çš„æé»ï¼Œæˆ–ç§ä¸‹çµ¦äºˆçš„æ©Ÿæœƒï¼Œä¿æŒè¬™è™›ã€‚' },
  { id: 'qingyang', name: 'æ“ç¾Š', type: 'unlucky', keyword: 'è¡å‹•ã€ä¸€åˆ€åˆ‡', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨ã€Œå¿«ã€ã€è¡å‹•ã€ç«¶çˆ­ã€è¡çªã€ä¸€åˆ€å…©æ–·ã€‚åŸ·è¡ŒåŠ›å¼·ä½†éæ–¼å°–éŠ³ï¼Œæ˜“å—å‚·ã€‚', advice: 'åšäº‹æœæ–·æ˜¯å¥½äº‹ï¼Œä½†è¦é¿å…é­¯è½èˆ‡äººç™¼ç”Ÿæ­£é¢è¡çªï¼Œæ³¨æ„å—å‚·èˆ‡è¡€å…‰ã€‚' },
  { id: 'tuoluo', name: 'é™€ç¾…', type: 'unlucky', keyword: 'æ‹–å»¶ã€ç³¾çµ', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨ã€Œæ…¢ã€ã€æ‹–å»¶ã€ç³¾çµã€åŸåœ°æ‰“è½‰ã€è¹‰è·æ­²æœˆã€‚åƒé™€èºä¸€æ¨£è½‰å€‹ä¸åœï¼Œé€²åº¦åœæ»¯ã€‚', advice: 'äº‹æƒ…æœƒå¡ä½æˆ–æ‹–å»¶ä¸€é™£å­ï¼Œé™·å…¥è¿´åœˆã€‚éœ€è¦æ¥µå¤§çš„è€å¿ƒå»é‡æ¸…ç³¾çµçš„é»ï¼Œåˆ‡å‹¿é‘½ç‰›è§’å°–ã€‚' },
  { id: 'huoxing', name: 'ç«æ˜Ÿ', type: 'unlucky', keyword: 'æ˜ç«ã€æš´è„¾æ°£', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨çˆ†ç™¼ã€æ˜ç«ã€æš´è„¾æ°£ã€çªç™¼ç‹€æ³ã€‚ä¾†å¾—å¿«å»å¾—å¿«ï¼Œåƒç«å±±çˆ†ç™¼ã€‚', advice: 'æ§åˆ¶æƒ…ç·’ï¼Œå°å¿ƒçªç™¼çš„æ„å¤–æˆ–çˆ­åŸ·ï¼Œé€Ÿæˆ°é€Ÿæ±ºï¼Œä¸è¦æ³¥æ³¥å¸¶æ°´ã€‚' },
  { id: 'lingxing', name: 'éˆ´æ˜Ÿ', type: 'unlucky', keyword: 'æš—ç«ã€å†·æˆ°', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨éš±å¿ã€æš—ç«ã€å†·æˆ°ã€ç²¾ç®—ã€‚åƒæ‚¶ç‡’é‹ä¸€æ¨£ï¼ŒæŠŠä¸æ»¿è¨˜åœ¨å¿ƒè£¡ã€‚', advice: 'æœ‰è©±ç›´èªªï¼Œä¸è¦æ‚¶åœ¨å¿ƒè£¡ç”Ÿæ‚¶æ°£æˆ–æå†·æˆ°ï¼Œä»¥å…é€ æˆå…§å‚·ã€‚' },
  { id: 'dikong', name: 'åœ°ç©º', type: 'unlucky', keyword: 'ç²¾ç¥ç©ºè™›ã€å¹»æƒ³', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨ç²¾ç¥ä¸Šçš„ç©ºè™›ã€å¹»æƒ³ã€ä¸å‹™å¯¦ã€å¾—è€Œå¾©å¤±ã€‚å¤©é¦¬è¡Œç©ºä½†ç¼ºä¹åŸ·è¡Œã€‚', advice: 'é©åˆå¾äº‹å‰µæ„ã€ç„å­¸æˆ–ç²¾ç¥å±¤é¢çš„æ€è€ƒï¼Œä¸é©åˆå…·é«”çš„é‡‘éŒ¢æŠ•è³‡ã€‚' },
  { id: 'dijie', name: 'åœ°åŠ«', type: 'unlucky', keyword: 'ç‰©è³ªæå¤±ã€å‹•ç›ª', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨ç‰©è³ªä¸Šçš„æå¤±ã€æ³¢å‹•ã€åŠè·¯æ””æˆªã€‚åƒæµªè£¡è¡ŒèˆŸï¼Œé¢¨éšªæ¥µå¤§ã€‚', advice: 'å±€å‹¢å‹•ç›ªä¸å®‰ï¼Œè«‹çœ‹ç·Šè·åŒ…ï¼Œä¿å®ˆè¡Œäº‹ï¼Œé¿å…å†’éšªæŠ•è³‡ã€‚' },
  { id: 'lucun', name: 'ç¥¿å­˜', type: 'lucky', keyword: 'å¤©è²¡ã€ä¿å®ˆ', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨å¤©å¾—ä¹‹è²¡ã€å„²è“„ã€è¬¹æ…ä¿å®ˆã€‚é›–ç„¶æœ‰éŒ¢ä½†å®¹æ˜“å­¤ç¨ï¼ˆç¾Šé™€å¤¾ç¥¿ï¼‰ã€‚', advice: 'æ¡å–ä¿å®ˆç©©å¥çš„ç†è²¡ç­–ç•¥ï¼Œç©ç©€é˜²é¥‘ï¼Œä¸è¦éš¨æ„è®Šå‹•ã€‚' },
  { id: 'tianma', name: 'å¤©é¦¬', type: 'special', keyword: 'è®Šå‹•ã€å¥”æ³¢', desc: 'ä¸­æ€§æ˜Ÿã€‚ä»£è¡¨è®Šå‹•ã€å¥”æ³¢ã€é è¡Œã€å¿™ç¢Œã€‚å‹•èµ·ä¾†æ‰æœ‰è²¡ï¼ˆç¥¿é¦¬äº¤é¦³ï¼‰ã€‚', advice: 'ä¸é©åˆéœå®ˆï¼Œå¿…é ˆå‹•èµ·ä¾†ï¼å‡ºå·®ã€æ—…éŠæˆ–æ”¹è®Šç¾ç‹€æœƒå¸¶ä¾†è½‰æ©Ÿã€‚' },
  { id: 'hualu', name: 'åŒ–ç¥¿', type: 'lucky', keyword: 'ç·£åˆ†ã€æ„‰æ‚…', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨ç·£åˆ†å¢åŠ ã€æ„‰æ‚…ã€äº«å—ã€é †åˆ©ã€è²¡ç¥¿ã€‚äººéš›é—œä¿‚çš„æ½¤æ»‘åŠ‘ã€‚', advice: 'ç¾åœ¨æ˜¯å»£çµå–„ç·£ã€äº«å—æˆæœçš„å¥½æ™‚æ©Ÿï¼Œä¿æŒæ„‰å¿«çš„å¿ƒæƒ…ã€‚' },
  { id: 'huaquan', name: 'åŒ–æ¬Š', type: 'neutral', keyword: 'æ¬ŠåŠ›ã€æŒæ§', desc: 'ä¸­æ€§æ˜Ÿã€‚ä»£è¡¨æŒæ¬Šã€æ§åˆ¶æ¬²ã€ç«¶çˆ­ã€å¼·å‹¢ã€è¡Œå‹•åŠ›ã€‚æƒ³è¦ä¸»å°ä¸€åˆ‡ã€‚', advice: 'ç©æ¥µçˆ­å–ä¸»å°æ¬Šï¼Œå±•ç¾ä½ çš„å°ˆæ¥­èˆ‡å¼·å‹¢ï¼Œä½†è¦å°å¿ƒäººéš›æ‘©æ“¦ã€‚' },
  { id: 'huake', name: 'åŒ–ç§‘', type: 'lucky', keyword: 'åè²ã€ç§‘ç”²', desc: 'å‰æ˜Ÿã€‚ä»£è¡¨åè²ã€ç§‘ç”²ã€é¢å­ã€å­¸è¡“è¡¨ç¾ã€è²´äººè§£å„ã€‚é‡è¦–å¤–åœ¨å½¢è±¡ã€‚', advice: 'æ„›æƒœç¾½æ¯›ï¼Œå»ºç«‹è‰¯å¥½çš„åè²èˆ‡å½¢è±¡ï¼Œæœ‰åˆ©æ–¼è€ƒè©¦æˆ–å‡é·ã€‚' },
  { id: 'huaji', name: 'åŒ–å¿Œ', type: 'unlucky', keyword: 'éºæ†¾ã€è™§æ¬ ', desc: 'ç…æ˜Ÿã€‚ä»£è¡¨è™§æ¬ ã€éºæ†¾ã€ç©ºç¼ºã€æ˜¯éã€ä¸é †ã€‚å‰ä¸–çš„å‚µï¼Œä»Šç”Ÿçš„åŠ«ã€‚', advice: 'é¢å°ç”Ÿå‘½ä¸­çš„ä¸åœ“æ»¿ï¼Œè¦–ç‚ºé‚„å‚µèˆ‡ä¿®è¡Œçš„éç¨‹ï¼Œä½èª¿å¿è€ã€‚' }
];

// åäºŒé•·ç”Ÿ 12 å¼µ
const twelveStagesData = [
  { name: 'é•·ç”Ÿ', keyword: 'èŒèŠ½ã€èµ·å§‹', desc: 'æ–°çš„é–‹å§‹ï¼Œç”Ÿæ©Ÿå‹ƒå‹ƒï¼Œæºæºä¸çµ•ã€‚', time: 'å¯…æ™‚ (03-05é»)', num: 1, energy: 'â­ï¸â­ï¸â­ï¸â­ï¸' },
  { name: 'æ²æµ´', keyword: 'ä¸ç©©ã€æ¡ƒèŠ±', desc: 'æ¡ƒèŠ±æ•—åœ°ï¼Œå–œæ–°å­èˆŠï¼Œä¸ç©©å®šã€‚', time: 'å¯æ™‚ (05-07é»)', num: 2, energy: 'â­ï¸â­ï¸' },
  { name: 'å† å¸¶', keyword: 'æˆé•·ã€åŒ…è£', desc: 'ç©¿è¡£æˆ´å¸½ï¼Œæ³¨é‡å¤–è¡¨ï¼Œå°æœ‰æˆå°±ã€‚', time: 'è¾°æ™‚ (07-09é»)', num: 3, energy: 'â­ï¸â­ï¸â­ï¸' },
  { name: 'è‡¨å®˜', keyword: 'æ­£å¼ã€å±•ç¾', desc: 'æ­£å¼ä»»è·ï¼ŒåŠªåŠ›å·¥ä½œï¼Œè–ªè³‡å¢é•·ã€‚', time: 'å·³æ™‚ (09-11é»)', num: 4, energy: 'â­ï¸â­ï¸â­ï¸â­ï¸' },
  { name: 'å¸æ—º', keyword: 'é ‚å³°ã€æ¥µè‡´', desc: 'é‹å‹¢é ‚å³°ï¼Œæ°£å‹¢å¼·ç››ï¼Œå”¯æˆ‘ç¨å°Šã€‚', time: 'åˆæ™‚ (11-13é»)', num: 5, energy: 'â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸' },
  { name: 'è¡°', keyword: 'è¡°é€€ã€å®ˆæˆ', desc: 'ç››æ¥µè€Œè¡°ï¼Œè½‰æ”»ç‚ºå®ˆï¼Œæ°£å‹¢æ¸›å¼±ã€‚', time: 'æœªæ™‚ (13-15é»)', num: 6, energy: 'â­ï¸â­ï¸â­ï¸' },
  { name: 'ç—…', keyword: 'æ¼æ´ã€ç„¡åŠ›', desc: 'èƒ½é‡ä¸è¶³ï¼Œæ¼æ´å‡ºç¾ï¼Œå¿ƒæœ‰é¤˜åŠ›ä¸è¶³ã€‚', time: 'ç”³æ™‚ (15-17é»)', num: 7, energy: 'â­ï¸â­ï¸' },
  { name: 'æ­»', keyword: 'éœæ­¢ã€åœæ»¯', desc: 'éœæ­¢ä¸å‹•ï¼Œç¼ºä¹ç”Ÿæ°£ï¼Œé‘½ç‰›è§’å°–ã€‚', time: 'é…‰æ™‚ (17-19é»)', num: 8, energy: 'â­ï¸' },
  { name: 'å¢“', keyword: 'æ”¶è—ã€è¢«å‹•', desc: 'æ”¶è—ç©ç´¯ï¼Œé™·å…¥è¢«å‹•ï¼Œè³‡æºè¢«é–ä½ã€‚', time: 'æˆŒæ™‚ (19-21é»)', num: 9, energy: 'â­ï¸â­ï¸' },
  { name: 'çµ•', keyword: 'æ–·çµ•ã€è°·åº•', desc: 'å®Œå…¨æ–·çµ•ï¼Œè·Œå…¥è°·åº•ï¼Œçµ•è™•é€¢ç”Ÿã€‚', time: 'äº¥æ™‚ (21-23é»)', num: 10, energy: 'â­ï¸' },
  { name: 'èƒ', keyword: 'å­•è‚²ã€è¦åŠƒ', desc: 'é‡æ–°å­•è‚²ï¼Œå¸Œæœ›èŒèŠ½ï¼Œå°šæœªæˆå½¢ã€‚', time: 'å­æ™‚ (23-01é»)', num: 11, energy: 'â­ï¸â­ï¸' },
  { name: 'é¤Š', keyword: 'ä¼‘é¤Šã€ç­‰å¾…', desc: 'ä¼‘é¤Šç”Ÿæ¯ï¼Œç­‰å¾…æ™‚æ©Ÿï¼Œæ¥å—å‘µè­·ã€‚', time: 'ä¸‘æ™‚ (01-03é»)', num: 12, energy: 'â­ï¸â­ï¸â­ï¸' }
];

// --- é‚è¼¯å·¥å…· ---
const shuffleArray = (array) => {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
};

// --- å…ƒä»¶ ---

const StarryBackground = () => (
  <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div className="absolute inset-0 bg-gradient-to-br from-purple-50 via-white to-purple-100">
       <div className="absolute top-0 left-0 w-full h-full opacity-40 bg-[radial-gradient(circle_at_50%_50%,_#e9d5ff_0%,_transparent_60%)]"></div>
       <div className="absolute bottom-0 right-0 w-full h-full opacity-30 bg-[radial-gradient(circle_at_80%_80%,_#fbcfe8_0%,_transparent_50%)]"></div>
    </div>
    {[...Array(60)].map((_, i) => (
      <div 
        key={i}
        className="absolute rounded-full bg-purple-300 opacity-60 animate-twinkle"
        style={{
          top: `${Math.random() * 100}%`,
          left: `${Math.random() * 100}%`,
          width: `${Math.random() * 3 + 1}px`, 
          height: `${Math.random() * 3 + 1}px`,
          animationDelay: `${Math.random() * 5}s`,
          animationDuration: `${Math.random() * 3 + 2}s`
        }}
      />
    ))}
  </div>
);

const Toast = ({ message, type, onClose }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);

  if (!message) return null;

  const bgClass = type === 'error' ? 'bg-red-500' : 'bg-green-500';

  return (
    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-lg text-white flex items-center gap-2 ${bgClass} animate-fade-in-down transition-all`}>
      {type === 'error' ? <XCircle size={20}/> : <Sparkles size={20}/>}
      <span className="font-medium text-sm">{message}</span>
    </div>
  );
};

// è£é£¾æ€§åœ–é¨°å…ƒä»¶
const DecorationPattern = ({ className }) => (
  <svg className={className} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M50 0C50 0 60 20 80 20C60 20 50 40 50 40C50 40 40 20 20 20C40 20 50 0 50 0Z" fill="currentColor" opacity="0.6"/>
    <path d="M50 100C50 100 60 80 80 80C60 80 50 60 50 60C50 60 40 80 20 80C40 80 50 100 50 100Z" fill="currentColor" opacity="0.6"/>
    <circle cx="50" cy="50" r="5" fill="currentColor" opacity="0.8"/>
  </svg>
);

const Card = ({ title, subtitle, shortDesc, type, id, isRevealed, delay = 0, isReversed = false, colorClass, extraInfo, onClick, isInteractable = false }) => {
  const [flipped, setFlipped] = useState(false);

  useEffect(() => {
    if (isRevealed) {
      const timer = setTimeout(() => setFlipped(true), delay);
      return () => clearTimeout(timer);
    } else {
      setFlipped(false);
    }
  }, [isRevealed, delay]);

  const contentStyle = isReversed 
    ? "bg-gradient-to-b from-slate-100 to-slate-300 text-slate-700" 
    : "bg-gradient-to-b from-purple-50 to-white text-purple-900";   
    
  const borderStyle = isReversed ? "border-slate-400" : "border-amber-200";
  const headerBg = isReversed ? "bg-slate-500" : "bg-purple-600";
  const headerText = isReversed ? "text-slate-100" : "text-amber-100";

  const getIcon = () => {
    if (type === 'main' && id && starIcons[id]) return starIcons[id];
    if (type === 'aux' && id && starIcons[id]) return starIcons[id];
    if (type === 'main') return <Star size={56} strokeWidth={1.5} />;
    if (type === 'aux') return <Sparkles size={48} strokeWidth={1.5} />;
    if (type === 'stage') return <RefreshCw size={48} strokeWidth={1.5} />;
    return <Star size={48} strokeWidth={1.5} />;
  };

  return (
    <div 
      className={`relative w-36 h-60 perspective-1000 m-2 ${isInteractable ? 'cursor-pointer hover:scale-105 transition-transform duration-300' : ''}`}
      onClick={onClick}
    >
      <div className={`relative w-full h-full transition-transform duration-700 transform-style-3d ${flipped ? 'rotate-y-180' : ''}`}>
        
        {/* --- Card Back: Mystic Mandala Theme --- */}
        <div className="absolute w-full h-full rounded-xl backface-hidden flex flex-col items-center justify-center overflow-hidden shadow-2xl border-2 border-purple-400/50 bg-[#1a0b2e]">
           <div className="absolute inset-0 opacity-30">
               <svg width="100%" height="100%">
                  <defs>
                    <pattern id="mandala" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                       <circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.5)"/>
                       <path d="M20 0 L40 20 L20 40 L0 20 Z" fill="none" stroke="rgba(168,85,247,0.2)" strokeWidth="1"/>
                    </pattern>
                  </defs>
                  <rect width="100%" height="100%" fill="url(#mandala)"/>
               </svg>
           </div>
           <div className="absolute w-28 h-28 border border-purple-500/30 rounded-full flex items-center justify-center animate-spin-slow">
              <div className="w-24 h-24 border border-fuchsia-500/20 rounded-full border-dashed"></div>
              <div className="w-20 h-20 border border-purple-400/20 rounded-full transform rotate-45"></div>
           </div>
           <div className="relative z-10 w-12 h-12 rounded-full bg-gradient-to-br from-purple-800 to-indigo-900 flex items-center justify-center shadow-[0_0_20px_rgba(168,85,247,0.9)] border border-purple-300/40">
             <span className="text-xl text-white font-serif font-bold drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]">ç´«</span>
           </div>
           <DecorationPattern className="absolute top-2 left-2 w-6 h-6 text-purple-500 rotate-45" />
           <DecorationPattern className="absolute top-2 right-2 w-6 h-6 text-purple-500 -rotate-45" />
           <DecorationPattern className="absolute bottom-2 left-2 w-6 h-6 text-purple-500 rotate-[135deg]" />
           <DecorationPattern className="absolute bottom-2 right-2 w-6 h-6 text-purple-500 rotate-[225deg]" />
        </div>

        {/* --- Card Front: Tarot Style --- */}
        <div className={`absolute w-full h-full rounded-xl shadow-xl backface-hidden rotate-y-180 flex flex-col overflow-hidden border-[5px] double-border ${borderStyle} ${contentStyle}`}>
          
          <div className="absolute inset-1 border border-current opacity-10 rounded-lg pointer-events-none"></div>

          <div className={`h-14 w-full flex flex-col items-center justify-center relative overflow-hidden ${headerBg}`}>
             <div className="absolute inset-0 bg-black/10"></div>
             <div className="flex items-center gap-2 relative z-10 w-full justify-center px-1">
                <DecorationPattern className={`w-4 h-4 ${headerText}`} />
                <h2 className={`font-serif text-lg font-bold tracking-widest ${headerText}`}>{title}</h2>
                <DecorationPattern className={`w-4 h-4 ${headerText}`} />
             </div>
             
             <div className={`flex items-center gap-1 text-[10px] font-bold px-3 py-0.5 rounded-full -mb-3 relative z-10 bg-white/90 text-purple-900 shadow-sm`}>
                {isReversed ? <ArrowDown size={10} className="text-slate-600"/> : <ArrowUp size={10} className="text-purple-600"/>}
                <span className={isReversed ? "text-slate-700" : "text-purple-800"}>
                    {type === 'main' ? (isReversed ? 'é€†ä½' : 'æ­£ä½') : subtitle}
                </span>
             </div>
          </div>

          <div className="flex-1 relative flex items-center justify-center p-3">
             <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                 <div className="w-24 h-24 border-2 border-current rounded-full border-dotted"></div>
                 <div className="absolute w-32 h-32 border border-current rounded-full opacity-50"></div>
             </div>
             
            {/* è§£æ±ºæ–‡å­—å€’ç½®å•é¡Œï¼šåªæ—‹è½‰åœ–æ¨™ï¼Œä¸æ—‹è½‰æ•´å€‹å®¹å™¨ */}
            <div className={`transform transition-transform duration-700 ${isReversed ? 'rotate-180 opacity-70 grayscale brightness-90' : 'text-purple-700 drop-shadow-lg'}`}>
               {getIcon()}
            </div>
            
            {extraInfo && <span className="absolute top-2 right-2 text-[10px] text-red-600 font-bold border border-red-400 px-1 rounded bg-white/90 shadow-sm">{extraInfo}</span>}
          </div>

          {/* é¡¯ç¤ºç°¡çŸ­é—œéµå­—è€Œéé•·æè¿° */}
          <div className={`p-2 text-center border-t border-current/10 min-h-[70px] flex items-center justify-center ${isReversed ? 'bg-slate-200/50' : 'bg-purple-100/30'}`}>
             <p className="text-sm font-bold tracking-wide line-clamp-2">
                {shortDesc}
             </p>
          </div>
        </div>
      </div>
    </div>
  );
};

const MiniCardBack = ({ onClick, index }) => (
  <div 
    onClick={() => onClick(index)}
    className="group relative w-16 h-24 sm:w-20 sm:h-32 cursor-pointer transition-all duration-300 hover:-translate-y-2 hover:z-10 perspective-1000"
    style={{ animationDelay: `${index * 0.05}s` }}
  >
      <div className="absolute inset-0 bg-purple-500 rounded-lg blur-md opacity-0 group-hover:opacity-40 transition-opacity duration-300"></div>
      <div className="absolute inset-0 rounded-lg border border-purple-400/50 shadow-md flex flex-col items-center justify-center overflow-hidden bg-[#1a0b2e] animate-fade-in-up">
         <div className="w-12 h-12 border border-purple-500/30 rounded-full flex items-center justify-center">
             <div className="w-1 h-1 bg-purple-200 rounded-full shadow-[0_0_8px_white]"></div>
         </div>
         <DecorationPattern className="absolute bottom-1 w-16 h-16 text-purple-800/20" />
      </div>
  </div>
);

const DrawingDeck = ({ title, count, onCardSelect, subtitle, refreshKey }) => {
  return (
    <div className="flex flex-col items-center w-full max-w-4xl px-2" key={refreshKey}>
       <div className="text-center mb-6 animate-pulse">
         <h3 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500 mb-1">
          {title}
        </h3>
        {subtitle && <p className="text-purple-800/60 text-xs">{subtitle}</p>}
       </div>
      
      <div className="flex flex-wrap justify-center gap-2 sm:gap-3">
        {[...Array(count)].map((_, i) => (
          <MiniCardBack key={i} index={i} onClick={onCardSelect} />
        ))}
      </div>
      <p className="mt-8 text-purple-800/40 text-xs font-light tracking-widest">è«‹è†è½å…§å¿ƒçš„è²éŸ³ï¼Œé»æ“Šä¸€å¼µç‰Œ</p>
    </div>
  );
};

const App = () => {
  const [step, setStep] = useState('input');
  const [drawPhase, setDrawPhase] = useState('main');
  const [question, setQuestion] = useState('');
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [currentDeck, setCurrentDeck] = useState([]);
  const [refreshKey, setRefreshKey] = useState(0); 
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [toast, setToast] = useState(null);
  const [selections, setSelections] = useState({
    main: null,
    aux: null,
    extraAux: null,
    stage: null
  });
  const resultsRef = useRef(null);

  // --- Firebase Authentication ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
      } else {
        try {
            await signInAnonymously(auth);
        } catch(e) {
            console.error("Auth failed", e);
        }
      }
    };
    initAuth();
  }, []);

  // --- Initialization Logic ---
  const initPhase = (phase, excludeName = null) => {
    setDrawPhase(phase);
    setRefreshKey(prev => prev + 1); 
    
    let deck = [];
    
    if (phase === 'main') {
      deck = shuffleArray(mainStarsData).map(star => ({
        ...star,
        isReversed: Math.random() > 0.5,
        type: 'main'
      }));
    } else if (phase === 'aux') {
      deck = shuffleArray(auxStarsData).map(star => ({ ...star, type: 'aux' }));
    } else if (phase === 'extra') {
      const remaining = auxStarsData.filter(s => s.name !== excludeName);
      deck = shuffleArray(remaining).map(star => ({ ...star, type: 'aux' }));
    } else if (phase === 'stage') {
      deck = shuffleArray(twelveStagesData).map(star => ({ ...star, type: 'stage' }));
    }
    
    setCurrentDeck(deck);
  };

  const showToast = (message, type = 'success') => {
    setToast({ message, type });
  };

  const startDrawing = async () => {
    if (!question.trim()) {
      showToast("è«‹èª å¿ƒè¼¸å…¥æ‚¨æƒ³è©¢å•çš„å•é¡Œ...", 'error');
      return;
    }
    if (!name.trim() || !email.trim()) {
      showToast("è«‹å¡«å¯«æ‚¨çš„å§“åèˆ‡ Email", 'error');
      return;
    }

    setIsSubmitting(true);

    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customer_leads'), {
            name,
            email,
            question,
            timestamp: new Date().toISOString(),
            status: 'new'
        });

        setIsSubmitting(false);
        setStep('drawing');
        setSelections({ main: null, aux: null, extraAux: null, stage: null });
        initPhase('main');
        showToast("è³‡æ–™å·²é€å‡ºï¼Œæ­£åœ¨æ´—ç‰Œ...", 'success');

    } catch (e) {
        console.error("Error adding document: ", e);
        setIsSubmitting(false);
        showToast("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
        setStep('drawing');
        initPhase('main');
    }
  };

  const handleCardClick = (index) => {
    const selectedCard = currentDeck[index];

    if (drawPhase === 'main') {
      const displayDesc = selectedCard.isReversed ? selectedCard.reversed.desc : selectedCard.upright.desc;
      const displayKeyword = selectedCard.isReversed ? selectedCard.reversed.keyword : selectedCard.upright.keyword;
      const displayAdvice = selectedCard.isReversed ? selectedCard.reversed.advice : selectedCard.upright.advice;
      
      setSelections(prev => ({ 
          ...prev, 
          main: { ...selectedCard, displayDesc, displayKeyword, displayAdvice } 
      }));
      setTimeout(() => initPhase('aux'), 500);
      
    } else if (drawPhase === 'aux') {
      setSelections(prev => ({ ...prev, aux: selectedCard }));
      if (selectedCard.name === 'å¤©é¦¬') {
        setTimeout(() => initPhase('extra', selectedCard.name), 500);
      } else {
        setTimeout(() => initPhase('stage'), 500);
      }
      
    } else if (drawPhase === 'extra') {
      setSelections(prev => ({ ...prev, extraAux: selectedCard }));
      setTimeout(() => initPhase('stage'), 500);
      
    } else if (drawPhase === 'stage') {
      setSelections(prev => ({ ...prev, stage: selectedCard }));
      setStep('result');
      
      setTimeout(() => {
         resultsRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }
  };

  const reset = () => {
    setQuestion('');
    setStep('input');
    setDrawPhase('main');
    setSelections({ main: null, aux: null, extraAux: null, stage: null });
  };

  const getDeepInterpretation = () => {
    if (!selections.main) return null;
    const { main, aux, extraAux, stage } = selections;

    const mainChar = main.displayKeyword.split('ã€')[0];
    const auxChar = aux.desc.split('ã€‚')[0];

    const coreStatus = main.isReversed ? "é€†ä½ï¼ˆæš—ï¼‰" : "æ­£ä½ï¼ˆäº®ï¼‰";
    let analysisCore = `é‡å°æ‚¨è©¢å•çš„ã€Œ${question}ã€ï¼Œä¸»æ˜Ÿã€${main.name}ã€‘å‘ˆç¾${coreStatus}ã€‚`;
    if(main.isReversed) {
        analysisCore += `\nâš ï¸ é€™é¡¯ç¤ºæ ¸å¿ƒèƒ½é‡ç›®å‰è¼ƒç‚ºä½è¿·æˆ–æ–¹å‘éŒ¯èª¤ï¼Œå…·é«”è¡¨ç¾ç‚ºã€Œ${main.displayKeyword}ã€ã€‚æ‚¨çš„å¿ƒæ…‹æˆ–è™•å¢ƒå¯èƒ½è¼ƒç‚ºæ™æ‰ï¼Œæˆ–æ˜¯å¤–åœ¨ç’°å¢ƒä¸é…åˆã€‚`;
    } else {
        analysisCore += `\nâœ¨ é€™æ˜¯ä¸€å€‹å¼·è€Œæœ‰åŠ›çš„å‰å…†ï¼Œæ ¸å¿ƒèƒ½é‡é£½æ»¿ï¼Œå…·é«”è¡¨ç¾ç‚ºã€Œ${main.displayKeyword}ã€ã€‚æ‚¨ç›®å‰æŒæ¡äº†ä¸»å‹•æ¬Šï¼Œæˆ–æ˜¯å±€å‹¢æ­£æœè‘—æœ‰åˆ©çš„æ–¹å‘ç™¼å±•ã€‚`;
    }

    let analysisAux = `è¼”ç‰Œã€${aux.name}ã€‘å¸¶ä¾†äº†ã€Œ${auxChar}ã€çš„å½±éŸ¿ã€‚${aux.desc}`;
    if(aux.name === 'å¤©é¦¬') {
        analysisAux = `è¼”ç‰Œå‡ºç¾ã€å¤©é¦¬ã€‘ï¼Œé¡¯ç¤ºé€™ä»¶äº‹ä¸æœƒéœæ­¢ä¸è®Šï¼Œè€Œæ˜¯è™•æ–¼ã€Œå¥”æ³¢è®Šå‹•ã€çš„ç‹€æ…‹ã€‚`;
    }

    if (extraAux) {
        analysisAux += ` æ­¤å¤–ï¼Œç”±æ–¼å¤©é¦¬çš„ç‰½å‹•ï¼Œè®Šå‹•ä¹‹å¾Œå°‡æœƒå¼•ç™¼ã€${extraAux.name}ã€‘çš„æ€§è³ªï¼Œé€™æ„å‘³è‘—äº‹æƒ…çš„çµæœæœƒå‚¾å‘æ–¼${extraAux.desc}`;
    }

    let analysisStage = `ç›®å‰çš„æ™‚é‹èƒ½é‡è™•æ–¼ã€${stage.name}ã€‘éšæ®µã€‚`;
    analysisStage += `\nâ±ï¸ æ™‚é–“æ‡‰æœŸï¼šæ­¤ç‰Œå°æ‡‰æ•¸å­—ç‚ºã€${stage.num}ã€‘ã€‚`;
    analysisStage += `é€™æ„å‘³è‘—äº‹æƒ…çš„ç™¼ç”Ÿæˆ–è½‰æŠ˜é»å¯èƒ½åœ¨ ${stage.num} å¤©ã€${stage.num} é€±ã€${stage.num} å€‹æœˆæˆ– ${stage.num} å¹´ä¹‹å¾Œï¼ˆè¦–å•é¡ŒçŸ­æœŸæˆ–é•·æœŸè€Œå®šï¼‰ã€‚`;
    analysisStage += `\nğŸ“… ç‰¹å®šæ™‚æ®µï¼šäº¦å¯åƒè€ƒ ${stage.time}ã€‚`;

    let synthesis = "";
    if(main.isReversed) {
        if(aux.type === 'lucky') {
             synthesis = `ã€éšªä¸­æ±‚ç©©å±€ã€‘\næ‚¨ç›®å‰çš„æ ¸å¿ƒç‹€æ…‹å‚¾å‘ã€Œ${mainChar}ã€ï¼Œé¡¯ç¤ºå…§å¿ƒæˆ–å±€å‹¢ä¸Šæœ‰ä¸ç©©å®šçš„å› å­ã€‚ä½†å¹¸é‹çš„æ˜¯ï¼Œè¼”ç‰Œã€Œ${aux.name}ã€å¸¶ä¾†äº†ã€Œ${auxChar}ã€çš„èƒ½é‡ã€‚é€™æ„å‘³è‘—é›–ç„¶æ‚¨å€‹äººç‹€æ…‹æœªé”å·”å³°ï¼Œä½†å¤–éƒ¨ç’°å¢ƒæˆ–è²´äººé‹æ¥µä½³ã€‚å»ºè­°æ‚¨ä¸è¦å¼·å‡ºé ­ï¼Œè€Œæ˜¯æ‡‚å¾—ã€Œå€ŸåŠ›ä½¿åŠ›ã€ï¼Œä¾è³´é€™è‚¡å¤–éƒ¨åŠ©åŠ›ä¾†åº¦éä½æ½®ã€‚`;
        } else {
             synthesis = `ã€åš´å³»è€ƒé©—å±€ã€‘\né€™æ˜¯ä¸€æ®µè¼ƒç‚ºè¾›è‹¦çš„æ™‚æœŸã€‚ä¸»æ˜Ÿå‘ˆç¾ã€Œ${mainChar}ã€çš„è² é¢ç‰¹è³ªï¼Œé¡¯ç¤ºå…§éƒ¨èƒ½é‡è€—ææˆ–æ–¹å‘è¿·å¤±ï¼›è€Œè¼”ç‰Œã€Œ${aux.name}ã€åˆå¸¶ä¾†ã€Œ${auxChar}ã€çš„è€ƒé©—ã€‚é€™ä»£è¡¨å…§æ†‚å¤–æ‚£åŒæ™‚å­˜åœ¨ã€‚å»ºè­°æ‚¨æ­¤åˆ»ã€Œä»¥éœåˆ¶å‹•ã€ï¼Œå…ˆè§£æ±ºå…§å¿ƒçš„çŸ›ç›¾ï¼Œé¿å…åœ¨æ··äº‚ä¸­åšé‡å¤§æ±ºå®šï¼Œä¿ç•™å¯¦åŠ›æ‰æ˜¯ä¸Šç­–ã€‚`;
        }
    } else {
        if(aux.type === 'lucky') {
             synthesis = `ã€ä¹˜é¢¨ç ´æµªå±€ã€‘\né€™æ˜¯ä¸€å€‹çµ•ä½³çš„çµ„åˆï¼ä¸»æ˜Ÿç™¼æ®äº†ã€Œ${mainChar}ã€çš„å„ªå‹¢ï¼Œèƒ½é‡é£½æ»¿ä¸”æ–¹å‘æ­£ç¢ºï¼›åŠ ä¸Šè¼”ç‰Œã€Œ${aux.name}ã€çµ¦äºˆã€Œ${auxChar}ã€çš„åŠ æŒã€‚é€™ä¸åƒ…æ˜¯é‹æ°£å¥½ï¼Œæ›´æ˜¯å¯¦åŠ›èˆ‡æ©Ÿæœƒçš„çµåˆã€‚è«‹å‹™å¿…æŠŠæ¡ç•¶ä¸‹ï¼Œå¤§è†½åŸ·è¡Œæ‚¨çš„è¨ˆç•«ï¼Œç¾åœ¨æ­£æ˜¯ã€Œæ°´åˆ°æ¸ æˆã€çš„é«˜å…‰æ™‚åˆ»ã€‚`;
        } else {
             synthesis = `ã€æŠ«èŠæ–¬æ£˜å±€ã€‘\næ‚¨æœ¬èº«å…·å‚™ã€Œ${mainChar}ã€çš„å¼·å¤§èƒ½åŠ›èˆ‡å„ªå‹¢ï¼Œä½†ç’°å¢ƒä¸­å»å­˜åœ¨ã€Œ${auxChar}ã€çš„å¹²æ“¾ï¼ˆç”±${aux.name}å¸¶ä¾†ï¼‰ã€‚é€™å°±åƒæ˜¯é§•é§›è·‘è»Šè¡Œé§›åœ¨é¡›ç°¸è·¯é¢ï¼Œé›–ç„¶æœ‰èƒ½åŠ›ï¼Œä½†éç¨‹é›£å…é¡›ç°¸ã€‚å»ºè­°æ‚¨ä¿æŒè€å¿ƒï¼Œåˆ©ç”¨ä¸»æ˜Ÿçš„å„ªå‹¢å»å…‹æœè¼”ç‰Œçš„é˜»ç¤™ï¼Œä¸è¦å› ä¸€æ™‚çš„æŒ«æŠ˜è€Œè‡ªæˆ‘æ‡·ç–‘ï¼Œæœ€çµ‚å®šèƒ½çªç ´é‡åœã€‚`;
        }
    }

    const finalAdvice = `${main.displayAdvice} åŒæ™‚ï¼Œ${aux.advice}`;

    return {
        core: analysisCore,
        aux: analysisAux,
        stage: analysisStage,
        synthesis: synthesis,
        advice: finalAdvice
    };
  };

  const resultData = step === 'result' ? getDeepInterpretation() : null;

  return (
    <div className="min-h-screen bg-purple-50 text-slate-800 font-sans selection:bg-purple-200 relative overflow-x-hidden">
      <StarryBackground />
      
      {toast && (
        <Toast 
          message={toast.message} 
          type={toast.type} 
          onClose={() => setToast(null)} 
        />
      )}
      
      <header className="p-4 text-center border-b border-purple-100 bg-white/70 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div className="flex items-center justify-center gap-3">
          <Moon className="text-purple-500 w-5 h-5 animate-pulse" />
          <h1 className="text-2xl font-bold tracking-[0.1em] text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
            å°æ­ ç´«éˆç‰Œ
          </h1>
          <Star className="text-purple-500 w-5 h-5 animate-pulse" />
        </div>
      </header>

      <main className="relative z-10 max-w-4xl mx-auto p-4 min-h-[85vh] flex flex-col items-center justify-center">
        
        {step === 'input' && (
          <div className="w-full max-w-lg bg-white/80 backdrop-blur-xl p-8 rounded-[2rem] border border-white shadow-2xl animate-fade-in">
            <div className="mb-6 text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-purple-200 animate-float">
                <MessageCircle size={36} className="text-white" />
              </div>
              <h2 className="text-xl font-semibold mb-2 text-purple-900">å¿ƒä¸­çš„ç–‘æƒ‘</h2>
              <p className="text-sm text-slate-500">å‘å®‡å®™ç™¼å‡ºä¿¡è™Ÿï¼Œæ˜Ÿè¾°å°‡ç‚ºæ‚¨æŒ‡å¼•æ–¹å‘</p>
            </div>

            {/* å€‹äººè³‡æ–™æ”¶é›†å€å¡Š */}
            <div className="mb-6 grid grid-cols-1 gap-4">
                <div className="relative">
                    <User className="absolute left-4 top-1/2 transform -translate-y-1/2 text-purple-400" size={20} />
                    <input 
                      type="text" 
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                      placeholder="æ‚¨çš„å§“å / æš±ç¨±"
                      className="w-full bg-white border border-purple-200 rounded-xl py-3 pl-12 pr-4 text-purple-900 placeholder-purple-300 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
                    />
                </div>
                <div className="relative">
                    <Mail className="absolute left-4 top-1/2 transform -translate-y-1/2 text-purple-400" size={20} />
                    <input 
                      type="email" 
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="æ‚¨çš„ Email"
                      className="w-full bg-white border border-purple-200 rounded-xl py-3 pl-12 pr-4 text-purple-900 placeholder-purple-300 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
                    />
                </div>
            </div>

            <div className="mb-6 bg-purple-50 p-5 rounded-xl border border-purple-100 text-slate-600 text-sm leading-relaxed space-y-3 font-light tracking-wide">
               <div>
                 <span className="font-bold text-purple-600 block mb-1">ç¬¬ä¸€æ­¥ï¼š</span>
                 æ‰¾ä¸€å€‹å®‰éœçš„ç’°å¢ƒåä¸‹ä¾†ã€‚é›™è…³æ”¾åœ¨åœ°é¢ï¼Œé›™æ‰‹æ”¾åˆ°è†è“‹ä¸Šã€‚
               </div>
               <div>
                 <span className="font-bold text-purple-600 block mb-1">ç¬¬äºŒæ­¥ï¼š</span>
                 æ…¢æ…¢é–‰ä¸Šçœ¼ç›ï¼Œæ„Ÿå—è…³æŒè²¼æœåœ°é¢ï¼Œæ„Ÿå—è‚Œè‚‰å¾è…³æŒä¸€è·¯å»¶ä¼¸åˆ°å¤§è…¿ã€è»€å¹¹åˆ°é ­é ‚ã€æ‰‹è…³ã€‚ä¸¦ä¸”æ”¾é¬†é€™äº›è‚Œè‚‰ã€‚ç„¶å¾Œæ…¢æ…¢çš„å°‡æ‰‹æ­åœ¨è†è“‹ä¸Šã€‚å°‡æ³¨æ„åŠ›æ”¾åœ¨é¼»å°–å‰æ–¹ã€‚æ„Ÿå—ä¸€ä¸‹ç©ºæ°£åœ¨é€™åœ°æ–¹éš¨è‘—ä½ çš„é¼»æ¯é€²å‡ºã€‚è§€å¯Ÿå‘¼å¸ä¸‰æ¬¡ã€‚æŠ½ç‰Œæ™‚æƒ³è‘—ä½ å¿ƒä¸­çš„ç–‘å•ã€‚
               </div>
            </div>
            
            <textarea 
              value={question}
              onChange={(e) => setQuestion(e.target.value)}
              placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è©¢å•çš„å•é¡Œ..."
              className="w-full bg-white border border-purple-200 rounded-2xl p-5 text-purple-900 placeholder-purple-300 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 h-32 resize-none mb-6 transition-all"
            />
            
            <button 
              onClick={startDrawing}
              disabled={isSubmitting}
              className={`group w-full bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-500 hover:to-pink-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-purple-200 flex items-center justify-center gap-2 transition-all transform ${isSubmitting ? 'opacity-70 cursor-not-allowed' : 'hover:scale-[1.02]'}`}
            >
              {isSubmitting ? (
                <>
                  <Loader2 size={20} className="animate-spin" />
                  <span>è³‡æ–™å‚³é€ä¸­...</span>
                </>
              ) : (
                <>
                  <Send size={20} className="group-hover:translate-x-1 transition-transform"/>
                  <span className="tracking-widest">é€å‡ºè³‡æ–™ä¸¦é–‹å§‹å åœ</span>
                </>
              )}
            </button>
          </div>
        )}

        {step === 'drawing' && (
          <div className="w-full flex flex-col items-center justify-center min-h-[60vh] animate-fade-in">
            <div className="mb-6 text-center">
              <span className="px-4 py-1 rounded-full bg-white/60 border border-purple-200 text-purple-800 text-xs tracking-wider mb-4 inline-block backdrop-blur-md shadow-sm">
                æ­£åœ¨è§£è®€ï¼š{question.length > 10 ? question.substring(0,10) + '...' : question}
              </span>
            </div>

            {drawPhase === 'main' && (
              <DrawingDeck 
                title="æŠ½å–ã€ä¸»æ˜Ÿã€‘" 
                subtitle="è«‹å¾ 14 å¼µç‰Œä¸­é¸å–ä¸€å¼µï¼Œä»£è¡¨æ ¸å¿ƒèƒ½é‡"
                count={14} 
                onCardSelect={handleCardClick}
                refreshKey={refreshKey} 
              />
            )}
            {drawPhase === 'aux' && (
              <DrawingDeck 
                title="æŠ½å–ã€è¼”ç‰Œã€‘" 
                subtitle="è«‹å¾ 18 å¼µç‰Œä¸­é¸å–ä¸€å¼µï¼Œä»£è¡¨åŠ©åŠ›æˆ–é˜»åŠ›"
                count={18} 
                onCardSelect={handleCardClick}
                refreshKey={refreshKey}
              />
            )}
            {drawPhase === 'extra' && (
              <DrawingDeck 
                title="âœ¨ å¤©é¦¬æ˜Ÿç¾ï¼" 
                subtitle="å¥”æ³¢è®Šå‹•ï¼Œè«‹å†åŠ æŠ½ä¸€å¼µ"
                count={17} 
                onCardSelect={handleCardClick}
                refreshKey={refreshKey}
              />
            )}
            {drawPhase === 'stage' && (
              <DrawingDeck 
                title="æŠ½å–ã€åäºŒé•·ç”Ÿã€‘" 
                subtitle="è«‹å¾ 12 å¼µç‰Œä¸­é¸å–ä¸€å¼µï¼Œä»£è¡¨æ™‚é–“é‹å‹¢"
                count={12} 
                onCardSelect={handleCardClick}
                refreshKey={refreshKey}
              />
            )}
          </div>
        )}

        {step === 'result' && selections.main && resultData && (
          <div ref={resultsRef} className="w-full flex flex-col items-center animate-fade-in-up pb-12">
            
            <div className="mb-10 text-center">
              <h3 className="text-purple-400 text-xs font-bold tracking-widest uppercase mb-2">Your Question</h3>
              <p className="relative text-xl sm:text-2xl font-serif text-purple-900 px-8 py-2 border-b border-purple-200 inline-block">
                "{question}"
              </p>
            </div>

            {/* ç‰Œé™£å±•ç¤ºå€ */}
            <div className="flex flex-wrap justify-center items-start gap-4 mb-12">
              {/* 1. Main Star */}
              <div className="flex flex-col items-center">
                <span className="text-yellow-600 text-xs mb-2 font-bold tracking-widest">ä¸»æ˜Ÿ</span>
                <Card 
                  title={selections.main.name}
                  subtitle={selections.main.element}
                  desc={selections.main.displayDesc}
                  shortDesc={selections.main.keyword} 
                  type="main"
                  id={selections.main.id}
                  isReversed={selections.main.isReversed}
                  isRevealed={true}
                  delay={100}
                  colorClass="border-yellow-400"
                />
              </div>

              {/* 2. Aux Star */}
              <div className="flex flex-col items-center">
                <span className="text-cyan-600 text-xs mb-2 font-bold tracking-widest">è¼”ç‰Œ</span>
                <div className="flex gap-2">
                    <Card 
                      title={selections.aux.name}
                      subtitle={selections.aux.type === 'lucky' ? 'å‰' : selections.aux.type === 'unlucky' ? 'å‡¶' : 'ç‰¹'}
                      desc={selections.aux.desc}
                      shortDesc={selections.aux.keyword}
                      type="aux"
                      id={selections.aux.id}
                      isRevealed={true}
                      delay={400}
                      colorClass={selections.aux.type === 'lucky' ? 'border-green-400' : selections.aux.type === 'unlucky' ? 'border-red-400' : 'border-blue-400'}
                    />
                    {selections.extraAux && (
                        <Card 
                          title={selections.extraAux.name}
                          subtitle="è®Šå‹•"
                          desc={selections.extraAux.desc}
                          shortDesc={selections.extraAux.keyword}
                          type="aux"
                          id={selections.extraAux.id}
                          isRevealed={true}
                          delay={800}
                          colorClass="border-blue-400"
                          extraInfo="å¤©é¦¬"
                        />
                    )}
                </div>
              </div>

              {/* 3. Stage Card */}
              <div className="flex flex-col items-center">
                <span className="text-gray-500 text-xs mb-2 font-bold tracking-widest">æ™‚é‹</span>
                <Card 
                  title={selections.stage.name}
                  subtitle={selections.stage.num}
                  desc={selections.stage.desc}
                  shortDesc={selections.stage.keyword}
                  type="stage"
                  isRevealed={true}
                  delay={selections.extraAux ? 1200 : 800}
                  colorClass="border-gray-400"
                />
              </div>
            </div>
            
            {/* æ–°å¢ï¼šç‰Œæ„è©³è§£è¡¨æ ¼ */}
            <div className="w-full max-w-3xl mb-8 bg-white/60 rounded-xl overflow-hidden border border-purple-200 shadow-md animate-fade-in-up">
                <div className="bg-purple-100/50 px-4 py-2 flex items-center gap-2 border-b border-purple-200">
                    <FileText size={16} className="text-purple-600" />
                    <span className="text-sm font-bold text-purple-800">ç‰Œé¢ä¸€è¦½è¡¨</span>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-700">
                        <thead className="text-xs text-slate-500 uppercase bg-purple-50/50">
                            <tr>
                                <th className="px-4 py-3">ç‰Œå</th>
                                <th className="px-4 py-3">ç‹€æ…‹</th>
                                <th className="px-4 py-3">æ ¸å¿ƒå«ç¾©</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-purple-100">
                            <tr className="bg-white">
                                <td className="px-4 py-3 font-medium text-purple-900">{selections.main.name}</td>
                                <td className="px-4 py-3">
                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${selections.main.isReversed ? 'bg-slate-200 text-slate-700' : 'bg-amber-100 text-amber-800'}`}>
                                        {selections.main.isReversed ? 'é€†ä½ (æš—)' : 'æ­£ä½ (äº®)'}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-slate-600">{selections.main.displayDesc}</td>
                            </tr>
                            <tr className="bg-purple-50/30">
                                <td className="px-4 py-3 font-medium text-cyan-900">{selections.aux.name}</td>
                                <td className="px-4 py-3">
                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${selections.aux.type === 'lucky' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                        {selections.aux.type === 'lucky' ? 'å‰æ˜Ÿ' : 'ç…æ˜Ÿ'}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-slate-600">{selections.aux.desc}</td>
                            </tr>
                            {selections.extraAux && (
                                <tr className="bg-blue-50/30">
                                    <td className="px-4 py-3 font-medium text-blue-900">{selections.extraAux.name} (å¤©é¦¬åŠ æŠ½)</td>
                                    <td className="px-4 py-3">
                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${selections.extraAux.type === 'lucky' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                            {selections.extraAux.type === 'lucky' ? 'å‰æ˜Ÿ' : 'ç…æ˜Ÿ'}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3 text-slate-600">{selections.extraAux.desc}</td>
                                </tr>
                            )}
                            <tr className="bg-white">
                                <td className="px-4 py-3 font-medium text-slate-900">{selections.stage.name}</td>
                                <td className="px-4 py-3">
                                    <span className="px-2 py-0.5 rounded text-xs font-bold bg-slate-200 text-slate-700">
                                        æ™‚é‹
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-slate-600">{selections.stage.desc}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            {/* æ·±åº¦åˆ†æå ±å‘Š */}
            <div className="w-full max-w-3xl bg-white/80 backdrop-blur-xl rounded-3xl p-8 border border-white shadow-2xl space-y-6 relative overflow-hidden">
              {/* è£é£¾èƒŒæ™¯ */}
              <div className="absolute top-0 right-0 w-40 h-40 bg-purple-200/30 rounded-full blur-3xl -mr-10 -mt-10"></div>
              
              <div className="flex items-center gap-3 pb-4 border-b border-purple-100 relative z-10">
                <BookOpen className="text-purple-500" />
                <h3 className="text-2xl font-bold text-purple-900">å°æ­ç‚º [{name}] çš„å°ˆå±¬ç´«éˆæ˜Ÿèª</h3>
              </div>

              <div className="space-y-6 relative z-10">
                
                <div className="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
                   <h4 className="text-indigo-800 font-bold text-sm mb-2 flex items-center gap-2">
                     <Crown size={16} className="text-indigo-600"/> æ ¸å¿ƒèƒ½é‡å®šèª¿
                   </h4>
                   <p className="text-indigo-900/80 leading-relaxed whitespace-pre-line font-medium">{resultData.core}</p>
                </div>

                <div className="bg-cyan-50 p-5 rounded-xl border border-cyan-100">
                   <h4 className="text-cyan-800 font-bold text-sm mb-2 flex items-center gap-2">
                     <Sparkles size={16} className="text-cyan-600"/> åŠ©åŠ›èˆ‡è®Šæ•¸
                   </h4>
                   <p className="text-cyan-900/80 leading-relaxed font-medium">{resultData.aux}</p>
                </div>

                <div className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                   <h4 className="text-slate-700 font-bold text-sm mb-2 flex items-center gap-2">
                     <Clock size={16} className="text-slate-600"/> æ™‚é–“èˆ‡é€²ç¨‹
                   </h4>
                   <p className="text-slate-700/80 leading-relaxed whitespace-pre-line font-medium">{resultData.stage}</p>
                </div>

                <div className="p-2">
                    <h4 className="text-purple-600 font-bold text-lg mb-3 flex items-center gap-2">
                        <Star size={20} className="fill-purple-600" /> å°æ­ç¶œåˆè©³è§£
                    </h4>
                    <p className="text-slate-700 leading-8 text-lg font-light">
                        {resultData.synthesis}
                    </p>
                </div>

                <div className="mt-4 p-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl border border-yellow-200 shadow-sm transform transition hover:scale-[1.01]">
                    <strong className="text-yellow-700 block mb-2 text-lg flex items-center gap-2">
                        <Lock size={20} /> é—œéµè¡Œå‹•æŒ‡å¼•
                    </strong>
                    <p className="text-yellow-800 font-medium tracking-wide text-lg">
                        {resultData.advice}
                    </p>
                </div>
              </div>
            </div>

            <div className="mt-8">
                <button 
                  onClick={reset}
                  className="px-8 py-3 rounded-full bg-white hover:bg-purple-50 border border-purple-200 text-purple-700 transition-all flex items-center gap-2 hover:scale-105 shadow-sm"
                >
                  <RefreshCw size={18} />
                  <span>å†æ¬¡å åœ</span>
                </button>
            </div>

          </div>
        )}
      </main>

      <style>{`
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        .animate-twinkle { animation: twinkle 3s infinite ease-in-out; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }

        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .double-border {
          box-shadow: 
            0 0 0 4px rgba(255,255,255,0.2),
            0 0 0 8px rgba(139, 92, 246, 0.1);
        }
      `}</style>
    </div>
  );
};

export default App;
